# Media Player (Медиаплеер)

## Обзор

Медиаплеер — это компонент, отвечающий за воспроизведение видео и аудио. Он обеспечивает просмотр медиафайлов, управление воспроизведением, синхронизацию с таймлайном и поддержку записи.

## Состояние

Медиаплеер управляется через машину состояний `playerMachine`, которая контролирует:

- Воспроизведение и паузу
- Перемотку
- Управление громкостью
- Синхронизацию времени между треками
- Обработку ошибок воспроизведения
- Поддержку записи

## Основные функции

- Воспроизведение/пауза
- Перемотка
- Управление громкостью
- Синхронизация времени между треками
- Обработка ошибок воспроизведения
- Поддержка записи

## Структура компонентов

### Основные компоненты

- `media-player/` - компоненты плеера
  - `media-player.tsx` - корневой компонент
  - `player-controls.tsx` - элементы управления
  - `player-timeline.tsx` - временная шкала
  - `player-volume.tsx` - управление громкостью
  - `player-fullscreen.tsx` - полноэкранный режим
  - `player-progress.tsx` - индикатор прогресса

### Дополнительные компоненты

- `dialogs/` - диалоговые окна
  - `camera-capture-dialog.tsx` - диалог захвата с камеры
  - `export-dialog.tsx` - диалог экспорта
  - `project-settings-dialog.tsx` - диалог настроек проекта

### Файлы состояния

- `machines/player-machine.ts` - машина состояний
- `providers/player-provider.tsx` - провайдер контекста

## Описание машины состояний

`playerMachine` управляет воспроизведением медиафайлов. Она контролирует состояние плеера (воспроизведение, пауза, перемотка), громкость, синхронизацию между треками и процесс записи. Машина также обрабатывает ошибки воспроизведения и управляет ссылками на видеоэлементы.

### Контекст playerMachine

- `video: MediaFile | null` - текущее видео
- `currentTime: number` - текущее время воспроизведения
- `duration: number` - длительность видео
- `volume: number` - громкость
- `isPlaying: boolean` - состояние воспроизведения
- `isSeeking: boolean` - состояние перемотки
- `isChangingCamera: boolean` - состояние смены камеры
- `isRecording: boolean` - состояние записи
- `videoRefs: Record<string, HTMLVideoElement>` - ссылки на видеоэлементы
- `videos: Record<string, TimelineVideo>` - все видео в проекте

### Методы playerMachine

- `setCurrentTime` - установка текущего времени
- `setIsPlaying` - управление воспроизведением
- `setIsSeeking` - управление перемоткой
- `setIsChangingCamera` - управление сменой камеры
- `setIsRecording` - управление записью
- `setVideoRefs` - установка ссылок на видеоэлементы
- `setVideo` - установка текущего видео
- `setVideos` - установка всех видео
- `setDuration` - установка длительности
- `setVolume` - управление громкостью

## Общая архитектура плеера

Плеер представляет собой React-компонент, который обеспечивает воспроизведение видео с различными функциями управления. Он состоит из нескольких основных компонентов:

1. **MediaPlayer** - основной компонент, который управляет воспроизведением видео
2. **PlayerControls** - компонент с элементами управления (кнопки воспроизведения, паузы, перемотки и т.д.)
3. **Timeline** - компонент для отображения временной шкалы и навигации по видео

Плеер использует контекст React (`usePlayerContext`) для хранения и передачи состояния между компонентами.

## Основные функции плеера

### Воспроизведение видео

- Плеер поддерживает воспроизведение видео с различными форматами и кодеками
- Управление воспроизведением (play/pause) через кнопки или клавиатуру
- Автоматическое возобновление воспроизведения после загрузки видео
- Обработка ошибок воспроизведения с автоматическими попытками восстановления

### Навигация по видео

- Перемотка вперед/назад с помощью кнопок или слайдера
- Переход к определенному времени через слайдер или временную шкалу
- Переход к началу/концу видео
- Покадровая навигация (вперед/назад на один кадр)

### Работа с параллельными видео

- Поддержка нескольких видео, снятых одновременно с разных камер
- Переключение между параллельными видео с сохранением относительной позиции
- Синхронизация времени между параллельными видео
- Обработка видео разной длительности с сохранением пропорциональной позиции

### Запись

- Возможность записи во время воспроизведения
- Автоматическое возобновление записи после переключения между видео
- Корректная обработка записи при переключении между параллельными видео

### Управление временем

- Поддержка как относительного времени, так и Unix timestamp
- Сохранение времени для каждого видео отдельно
- Сохранение времени для каждого сектора (дня)
- Восстановление позиции воспроизведения при переключении между видео

## Детальное описание работы

### Инициализация видео

1. При монтировании компонента `MediaPlayer` или изменении активного видео:

   - Создается видео-элемент и устанавливается источник (src)
   - Добавляются обработчики событий (loadedmetadata, timeupdate, error и т.д.)
   - Инициализируется начальное время воспроизведения

2. При загрузке метаданных видео:
   - Определяется длительность видео
   - Устанавливается начальное время воспроизведения:
     - Если есть сохраненное время для этого видео, используется оно
     - Если нет, но есть параллельные видео, вычисляется пропорциональное время
     - В противном случае используется 0 или сохраненное время для сектора

### Воспроизведение и пауза

1. При нажатии на кнопку воспроизведения/паузы:

   - Если идет процесс переключения камеры, действие игнорируется
   - Иначе переключается состояние `isPlaying`
   - При паузе сохраняется текущее время воспроизведения
   - При воспроизведении устанавливается сохраненное время и запускается видео

2. Во время воспроизведения:
   - Обновляется текущее время (`currentTime`) для отображения на слайдере
   - Сохраняется время для текущего видео
   - Обновляется положение слайдера и временной шкалы

### Переключение между параллельными видео

1. При нажатии на кнопку переключения камеры:

   - Проверяется, не идет ли уже процесс переключения
   - Сохраняется текущее время воспроизведения
   - Вычисляется относительная позиция (текущее время / длительность)
   - Если активна запись, она временно приостанавливается
   - Устанавливается флаг `isChangingCamera`
   - Устанавливается новое активное видео

2. После установки нового видео:
   - Вычисляется новое время на основе относительной позиции и длительности нового видео
   - Устанавливается новое время для видео-элемента
   - Сбрасывается флаг `isChangingCamera`
   - Если была активна запись, она возобновляется
   - Если видео было на паузе, но была активна запись, запускается воспроизведение

## Взаимодействие с другими компонентами

### Взаимодействие с браузером

- Получение медиафайлов для воспроизведения
- Обновление метаданных при изменении файлов

### Взаимодействие с таймлайном

- Синхронизация времени воспроизведения
- Обновление текущего времени
- Воспроизведение выбранных клипов

## Примеры использования

### Воспроизведение видео

```typescript
// В компоненте плеера
const { setIsPlaying, isPlaying } = usePlayer();

const handlePlayPause = () => {
  setIsPlaying(!isPlaying);
};
```

### Перемотка

```typescript
// В компоненте плеера
const { setCurrentTime, duration } = usePlayer();

const handleSeek = (time: number) => {
  setCurrentTime(time);
};

const handleSkipForward = () => {
  setCurrentTime((prev) => Math.min(prev + 10, duration));
};

const handleSkipBackward = () => {
  setCurrentTime((prev) => Math.max(prev - 10, 0));
};
```

## Планы по развитию

- Улучшение синхронизации между параллельными видео
- Добавление поддержки субтитров
- Улучшение обработки ошибок воспроизведения
- Оптимизация производительности при работе с большими файлами
- Добавление поддержки 360-градусных видео

## Связанные документы

- [Обзор архитектуры](../architecture/overview.md)
- [Машины состояний](../architecture/state-machines.md)
- [Руководство пользователя по плееру](../user-guide/player.md)
