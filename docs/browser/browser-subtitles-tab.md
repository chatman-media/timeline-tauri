# Документация по вкладке Субтитров (Subtitles Tab)

## Общее описание

Вкладка Субтитров является одной из вкладок компонента Browser в приложении Timeline Studio. Она предназначена для просмотра, поиска и выбора стилей субтитров, которые можно добавить на временную шкалу проекта. Субтитры позволяют добавлять текст к видео с различными стилями оформления.

## Структура файлов

```
src/features/browser/components/tabs/subtitles/
├── subtitles-list.tsx           # Основной компонент списка стилей субтитров
├── subtitles-preview.tsx        # Компонент предпросмотра стиля субтитров
├── subtitles.ts                 # Типы и утилиты для работы с субтитрами
├── subtitles-list.test.tsx      # Тесты для компонента списка субтитров
├── subtitles-preview.test.tsx   # Тесты для компонента предпросмотра субтитров
└── subtitles.test.ts            # Тесты для типов и утилит
```

## Хуки

### usePreviewSize (`preview-size-provider.tsx`)

Вкладка Субтитров использует общий хук `usePreviewSize` из директории `src/features/browser/components/preview/` для управления размером превью.

**Пример использования:**
```tsx
const {
  previewSize,
  increaseSize,
  decreaseSize,
  canIncreaseSize,
  canDecreaseSize,
} = usePreviewSize();
```

### useResources (`resources-provider.tsx`)

Вкладка Субтитров использует хук `useResources` для работы с ресурсами субтитров, который предоставляет методы для добавления и удаления стилей субтитров в проекте.

**Пример использования:**
```tsx
const {
  addSubtitle,
  isSubtitleAdded,
  removeResource,
  subtitleResources,
} = useResources();
```

### useMedia (`media-provider.tsx`)

Вкладка Субтитров использует хук `useMedia` для работы с избранными стилями субтитров, который предоставляет методы для добавления и удаления стилей из избранного.

**Пример использования:**
```tsx
const {
  isItemFavorite,
  toggleFavorite,
} = useMedia();

// Проверка, находится ли стиль в избранном
const isFavorite = isItemFavorite(
  { id: style.id, path: "", name: style.name },
  "sbtitle"
);
```

## Компоненты

### SubtitlesList (`subtitles-list.tsx`)

Основной компонент для отображения списка стилей субтитров.

**Пропсы:**
- Нет внешних пропсов, все данные получаются из контекста

**Состояние:**
- `searchQuery` - текущий поисковый запрос
- `showFavoritesOnly` - флаг отображения только избранных стилей

**Функциональность:**
- Отображение списка доступных стилей субтитров с превью
- Поиск стилей по названию
- Фильтрация по избранным стилям
- Изменение размера превью
- Добавление субтитров на временную шкалу при клике

**Особенности:**
- Использует общий хук `usePreviewSize` для управления размером превью
- Интегрируется с системой избранного через хук `useMedia`
- Имеет панель инструментов с поиском, фильтрацией и управлением размером превью
- Отображает стили субтитров в виде сетки с адаптивным количеством колонок

### SubtitlesPreview (`subtitles-preview.tsx`)

Компонент для отображения превью стиля субтитров.

**Пропсы:**
- `style` - объект стиля субтитров
- `size` - размер превью
- `onClick` - функция, вызываемая при клике на превью

**Функциональность:**
- Отображение превью стиля субтитров с примером текста
- Отображение названия стиля
- Кнопка для добавления стиля в избранное
- Кнопка для добавления стиля в проект
- Обработка клика для добавления субтитров на временную шкалу

**Особенности:**
- Отображает пример текста с применённым стилем
- Имеет кнопки для добавления в проект и в избранное
- Интегрируется с системой ресурсов через хук `useResources`
- Интегрируется с системой избранного через компонент `FavoriteButton`

## Типы и интерфейсы

### SubtitleStyle (`subtitles.ts`)

Интерфейс, описывающий стиль субтитров.

```typescript
export interface SubtitleStyle {
  id: string;                // Уникальный идентификатор стиля
  name: string;              // Название стиля
  category: string;          // Категория стиля
  fontFamily: string;        // Семейство шрифта
  fontSize: number;          // Размер шрифта
  fontWeight: string | number; // Жирность шрифта
  fontStyle: string;         // Стиль шрифта (normal, italic)
  textAlign?: string;        // Выравнивание текста
  color: string;             // Цвет текста
  backgroundColor?: string;  // Цвет фона
  textShadow?: string;       // Тень текста
  padding?: number;          // Отступы
  borderRadius?: number;     // Скругление углов фона
}
```

### SubtitleCategory (`subtitles.ts`)

Интерфейс, описывающий категорию стилей субтитров.

```typescript
export interface SubtitleCategory {
  id: string;                // Уникальный идентификатор категории
  name: string;              // Название категории
  styles: SubtitleStyle[];   // Список стилей в категории
}
```

### SubtitleResource (`types/resources.ts`)

Интерфейс, описывающий ресурс субтитров в проекте.

```typescript
export interface SubtitleResource extends TimelineResource {
  type: "subtitle";          // Тип ресурса
  resourceId: string;        // ID стиля субтитров
  name: string;              // Название ресурса
  params: Record<string, any>; // Параметры ресурса
}
```

## Интеграция с другими компонентами

### Интеграция с Preview Size

Вкладка Субтитров использует общий механизм управления размером превью, реализованный в виде хука `usePreviewSize` из директории `src/features/browser/components/preview/`.

### Интеграция с системой ресурсов

Вкладка Субтитров интегрируется с системой ресурсов через хук `useResources`, который предоставляет следующие методы:
- `addSubtitle` - добавляет стиль субтитров в проект
- `removeResource` - удаляет ресурс из проекта
- `isSubtitleAdded` - проверяет, добавлен ли стиль субтитров в проект
- `subtitleResources` - массив ресурсов субтитров в проекте

### Интеграция с системой избранного

Вкладка Субтитров интегрируется с системой избранного через хук `useMedia`, который предоставляет следующие методы:
- `isItemFavorite` - проверяет, находится ли элемент в избранном
- `toggleFavorite` - добавляет/удаляет элемент из избранного

### Интеграция с Timeline

Вкладка Субтитров интегрируется с компонентом Timeline для:
- Добавления выбранных стилей субтитров на временную шкалу
- Редактирования текста субтитров на временной шкале
- Настройки времени отображения субтитров

## Особенности реализации

### Предпросмотр стилей субтитров

Предпросмотр стилей субтитров реализован с использованием динамического рендеринга текста с применением CSS-стилей:
1. Стиль субтитров преобразуется в CSS объект с помощью функции `subtitleStyleToCss`
2. CSS объект применяется к элементу с текстом превью
3. Размер шрифта масштабируется в зависимости от размера превью

### Категории стилей субтитров

Стили субтитров группируются по категориям для удобства навигации:
- Basic (Базовые) - простые стили без сложного оформления
- Cinematic (Кинематографические) - стили, имитирующие субтитры в фильмах
- Animated (Анимированные) - стили с анимацией появления/исчезновения
- Stylized (Стилизованные) - стили с художественным оформлением
- и другие

### Интеграция с системой избранного

Для работы с избранными стилями субтитров используется тип "sbtitle" в системе избранного:
1. При добавлении стиля в избранное, он сохраняется в массиве `favorites.sbtitle`
2. При проверке, находится ли стиль в избранном, используется функция `isItemFavorite` с типом "sbtitle"
3. Кнопка избранного отображается для всех стилей субтитров

## Реализованная функциональность

### Основные возможности

- Отображение списка доступных стилей субтитров
- Предпросмотр стилей субтитров с примером текста
- Поиск стилей субтитров по названию
- Фильтрация по избранным стилям
- Изменение размера превью
- Добавление стилей субтитров в проект
- Добавление стилей субтитров в избранное

## Планируемая функциональность

### Расширенные возможности

- Создание пользовательских стилей субтитров
- Импорт субтитров из файлов SRT, VTT
- Автоматическое распознавание речи для создания субтитров
- Перевод субтитров на другие языки
- Синхронизация субтитров с аудиодорожкой
- Редактирование текста субтитров на временной шкале
- Настройка времени отображения субтитров

## Примеры использования

### Инициализация вкладки Субтитров

```tsx
// В компоненте Browser
import { SubtitlesList } from "./tabs/subtitles";

function Browser() {
  return (
    <div className="browser">
      <SubtitlesList />
    </div>
  );
}
```

### Фильтрация стилей субтитров

```tsx
// В компоненте SubtitlesList
const [searchQuery, setSearchQuery] = useState("");
const [showFavoritesOnly, setShowFavoritesOnly] = useState(false);
const { isItemFavorite } = useMedia();

// Фильтрация стилей по поисковому запросу и избранным
const filteredStyles = allSubtitleStyles.filter((style) => {
  // Фильтрация по поисковому запросу
  const searchLower = searchQuery.toLowerCase();
  const matchesSearch = style.name.toLowerCase().includes(searchLower);

  // Фильтрация по избранному
  const matchesFavorites =
    !showFavoritesOnly ||
    isItemFavorite(
      { id: style.id, path: "", name: style.name },
      "sbtitle",
    );

  // Стиль должен соответствовать обоим условиям
  return matchesSearch && matchesFavorites;
});
```

### Добавление стиля субтитров в проект

```tsx
// В компоненте SubtitlesPreview
const { addSubtitle, isSubtitleAdded, removeResource, subtitleResources } = useResources();

// Добавление стиля субтитров в проект
const handleAddSubtitle = (e: React.MouseEvent) => {
  e.stopPropagation(); // Предотвращаем всплытие события клика
  addSubtitle(style); // Добавляем стиль субтитров в ресурсы проекта
};

// Удаление стиля субтитров из проекта
const handleRemoveSubtitle = (e: React.MouseEvent) => {
  e.stopPropagation(); // Предотвращаем всплытие события клика
  // Находим ресурс с этим стилем и удаляем его
  const resource = subtitleResources.find(
    (res: SubtitleResource) => res.resourceId === style.id,
  );
  if (resource) {
    removeResource(resource.id); // Удаляем ресурс из проекта
  }
};
```

## Тестирование

Для тестирования компонентов вкладки Субтитров реализованы следующие тесты:

### SubtitlesList (`subtitles-list.test.tsx`)

- Проверка корректного рендеринга всех элементов
- Проверка фильтрации стилей по поисковому запросу
- Проверка фильтрации стилей по избранным
- Проверка изменения размера превью
- Проверка вызова обработчика клика по стилю
- Проверка отображения сообщения "not found"

### SubtitlesPreview (`subtitles-preview.test.tsx`)

- Проверка корректного рендеринга всех элементов
- Проверка вызова обработчика клика
- Проверка добавления и удаления стиля субтитров
- Проверка корректного отображения кнопок в зависимости от состояния
- Проверка применения стилей к превью субтитров

### Subtitles (`subtitles.test.ts`)

- Проверка структуры категорий и стилей субтитров
- Проверка уникальности идентификаторов стилей
- Проверка текста для превью субтитров
- Проверка функции преобразования стиля субтитров в CSS объект

## Примечания для разработчиков

- При добавлении новых стилей субтитров, добавляйте их в массив `SUBTITLE_STYLES` в файле `subtitles.ts`
- При добавлении новых категорий стилей, добавляйте их в массив `SUBTITLE_CATEGORIES` в файле `subtitles.ts`
- Для тестирования компонентов используйте моки для хуков `useResources` и `useMedia`
- При изменении структуры стилей субтитров, обновляйте функцию `subtitleStyleToCss` для корректного преобразования в CSS
- При реализации расширенных возможностей учитывайте необходимость поддержки различных языков и направлений текста
- Для стилей с анимацией учитывайте производительность на мобильных устройствах
- При интеграции с API распознавания речи для автоматического создания субтитров, используйте асинхронные запросы
