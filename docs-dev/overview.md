# Обзор архитектуры Timeline Editor

## Общая архитектура

Timeline Editor построен на основе современного стека веб-технологий с использованием React и Next.js. Архитектура приложения разделена на несколько ключевых слоев:

1. **Пользовательский интерфейс (UI)** - React-компоненты, отвечающие за отображение и взаимодействие с пользователем
2. **Управление состоянием** - XState машины состояний для управления сложной логикой приложения
3. **Сервисный слой** - API и сервисы для работы с медиафайлами, обработки видео и аудио
4. **Хранение данных** - локальное хранение файлов и метаданных

## Диаграмма архитектуры

```
+----------------------------------+
|           Пользователь           |
+----------------------------------+
                 |
+----------------------------------+
|      Пользовательский интерфейс  |
|                                  |
|  +------------+ +-------------+  |
|  |   Браузер  | |   Таймлайн  |  |
|  +------------+ +-------------+  |
|  +------------+ +-------------+  |
|  |    Плеер   | |  Настройки  |  |
|  +------------+ +-------------+  |
+----------------------------------+
                 |
+----------------------------------+
|      Управление состоянием       |
|                                  |
|  +------------+ +-------------+  |
|  |  Browser   | |  Timeline   |  |
|  |  Machine   | |   Machine   |  |
|  +------------+ +-------------+  |
|  +------------+ +-------------+  |
|  |   Player   | |   Project   |  |
|  |  Machine   | |   Machine   |  |
|  +------------+ +-------------+  |
+----------------------------------+
                 |
+----------------------------------+
|         Сервисный слой           |
|                                  |
|  +------------+ +-------------+  |
|  |  Media API | |  Music API  |  |
|  +------------+ +-------------+  |
|  +------------+ +-------------+  |
|  | Thumbnail  | |   Export    |  |
|  |    API     | |    API      |  |
|  +------------+ +-------------+  |
+----------------------------------+
                 |
+----------------------------------+
|        Хранение данных           |
|                                  |
|  +------------+ +-------------+  |
|  |   Медиа-   | |   Музыка    |  |
|  |   файлы    | |             |  |
|  +------------+ +-------------+  |
|  +------------+ +-------------+  |
|  | Миниатюры  | |  Настройки  |  |
|  |            | |             |  |
|  +------------+ +-------------+  |
+----------------------------------+
```

## Ключевые технологии

- **Frontend**: React, Next.js, TypeScript
- **Управление состоянием**: XState
- **Стилизация**: Tailwind CSS, Shadcn UI
- **Обработка медиа**: FFmpeg (через API)
- **API**: Next.js API Routes
- **Тестирование**: Vitest, React Testing Library, Playwright

## Основные принципы архитектуры

### 1. Компонентный подход

Приложение разделено на независимые компоненты, каждый из которых отвечает за свою часть функциональности. Это обеспечивает:

- Модульность и переиспользуемость кода
- Упрощение тестирования
- Возможность параллельной разработки

### 2. Машины состояний (XState)

Для управления сложной логикой приложения используются машины состояний XState, которые:

- Обеспечивают предсказуемое поведение приложения
- Упрощают обработку сложных пользовательских сценариев
- Централизуют логику управления состоянием

### 3. API-ориентированная архитектура

Взаимодействие с медиафайлами и обработка видео происходит через API:

- Отделение логики обработки медиа от UI
- Возможность масштабирования и оптимизации
- Асинхронная обработка тяжелых операций

### 4. Оптимизация производительности

Архитектура учитывает необходимость работы с большими медиафайлами:

- Ленивая загрузка компонентов
- Кэширование данных и миниатюр
- Оптимизация рендеринга React-компонентов

## Потоки данных

### Загрузка и отображение медиафайлов

1. Пользователь добавляет медиафайлы в приложение
2. API сканирует директории и извлекает метаданные с помощью FFmpeg
3. Браузер медиафайлов получает данные через API и отображает их
4. При выборе файла генерируются миниатюры и предпросмотр

### Работа с таймлайном

1. Пользователь добавляет медиафайлы на таймлайн
2. Таймлайн создает клипы и размещает их на дорожках в соответствующих секторах (датах)
3. Машина состояний таймлайна управляет позиционированием и взаимодействием
4. Плеер синхронизируется с таймлайном для воспроизведения

#### Особенности организации таймлайна

Таймлайн в Timeline Editor имеет уникальную организацию:

1. **Секторы по датам** - таймлайн разделен на секторы, соответствующие датам съемки
2. **Шкала реального времени дня** - вместо относительного времени используется реальное время дня
3. **Синхронизация по времени создания** - видео с разных камер автоматически синхронизируются по времени съемки

### Экспорт проекта

1. Пользователь настраивает параметры экспорта
2. API получает данные о расположении клипов на таймлайне
3. FFmpeg обрабатывает и объединяет медиафайлы
4. Результат сохраняется и становится доступным для скачивания

## Планы развития архитектуры

- Улучшение производительности при работе с большими файлами
- Добавление облачного хранения и синхронизации
- Интеграция с ИИ для автоматического монтажа

## Связанные документы

- [Компоненты системы](components.md)
- [Машины состояний](state-machines.md)
- [Настройка окружения разработки](../development/setup.md)
